# テスト実施ガイド - 修正内容の動作確認

このドキュメントは、以下3つの修正内容の動作確認手順をまとめたものです。

## 📋 修正内容の概要

1. **会員登録時の予約データ保存改善** (`app/register/page.tsx`)
2. **ネイティブ日付入力への刷新** (`components/ui/DatePicker.tsx`)
3. **予約作成APIの厳格な検証** (`app/api/reservations/create/route.ts`)

---

## 🔧 事前準備

### ローカル開発環境でテストする場合

```bash
# 1. メンテナンスモードを無効化（ローカルのみ）
# .env.local ファイルに以下を追加/変更
NEXT_PUBLIC_MAINTENANCE_MODE=false

# 2. 開発サーバー起動
npm run dev

# 3. ブラウザで開く
# http://localhost:3000
```

### 本番環境でテストする場合

**注意**: 本番環境は現在メンテナンスモード中です。テストには以下の方法があります：

1. **ローカル環境を推奨** - 安全にテスト可能
2. **本番環境でテスト** - メンテナンスモードを一時的に解除する必要あり

---

## 🧪 テストシナリオ

### テスト1: 会員登録→予約復元フロー

**目的**: 会員登録画面で修正した個人情報が、予約データに正しく反映されるか確認

#### 手順

**ステップ1: 予約フォームで初期入力**
1. http://localhost:3000/reservation にアクセス
2. サービスを選択（例: 4Dまつ毛エクステ）
3. 日付・時刻を選択
4. 以下の情報で入力:
   ```
   氏名: 田中太郎
   メールアドレス: taro@test.com
   電話番号: 090-1111-1111
   備考: テスト予約
   ```
5. 「予約を確定する」ボタンをクリック

**ステップ2: 会員登録画面で情報変更**
- 未登録ユーザーの場合、自動的に会員登録画面にリダイレクトされる
- 予約情報が保存されている旨のメッセージが表示される
- 以下のように情報を**変更**:
  ```
  氏名: 田中花子
  メールアドレス: hanako@test.com
  電話番号: 090-2222-2222
  パスワード: TestPass123!
  確認用パスワード: TestPass123!
  誕生日: 1990-01-01
  利用規約: チェック
  ```
6. 「会員登録」ボタンをクリック

**ステップ3: 予約画面で確認**
- 登録成功後、予約画面にリダイレクトされる
- **確認ポイント**:
  ```
  ✅ 氏名が「田中花子」になっている
  ✅ メールアドレスが「hanako@test.com」になっている
  ✅ 電話番号が「090-2222-2222」になっている
  ✅ サービス情報は維持されている
  ✅ 日付・時刻は維持されている
  ✅ 備考は維持されている
  ```

**期待結果**:
- ✅ すべての個人情報が会員登録時の入力値に更新されている
- ✅ サービス選択情報は変更されていない
- ✅ エラーなく予約を完了できる

**失敗ケース**:
- ❌ 氏名が「田中太郎」のまま → **修正が反映されていない**
- ❌ メールアドレスが「taro@test.com」のまま → **修正が反映されていない**

---

### テスト2: ネイティブDatePickerの動作確認

**目的**: `input[type="date"]`がブラウザ別に正しく動作するか確認

#### テストブラウザ

1. **Chrome (Desktop)** - カレンダーピッカー
2. **Safari (iOS)** - ドラム式ピッカー
3. **Firefox** - カレンダーピッカー

#### 手順

**各ブラウザで以下を実施**:

1. http://localhost:3000/register にアクセス
2. 「誕生日」フィールドを確認

**テストケース A: 日付選択**
```
1. 誕生日フィールドをクリック
2. 日付ピッカーが表示される
3. 「1990-01-15」を選択
4. フィールドに「1990-01-15」が表示される
```

**期待結果**:
- ✅ Chrome: カレンダーUIが表示され、日付選択可能
- ✅ Safari (iOS): ドラム式UIが表示され、日付選択可能
- ✅ Firefox: カレンダーUIが表示され、日付選択可能

**テストケース B: クリアボタン**
```
1. 誕生日に「1990-01-15」を選択
2. 「クリア」ボタンが表示される
3. 「クリア」ボタンをクリック
4. フィールドが空欄になる
```

**期待結果**:
- ✅ 日付選択後に「クリア」ボタンが表示される
- ✅ クリック後、フィールドが空になる
- ✅ 必須フィールドでない場合、空欄のまま送信できる

**テストケース C: 必須入力チェック**
```
1. 誕生日を空欄のまま「会員登録」をクリック
2. （誕生日は任意なので）エラーなく次に進める
```

**期待結果**:
- ✅ 誕生日は任意項目なので、空欄でも登録可能

**テストケース D: 日付範囲制限**
```
1. 誕生日ピッカーを開く
2. 未来の日付は選択できない
3. 100年以上前の日付は選択できない
```

**期待結果**:
- ✅ 今日より未来の日付は選択不可
- ✅ 100年以上前の日付は選択不可

---

### テスト3: 予約作成APIのバリデーション

**目的**: サーバー側の厳格な検証が正しく機能するか確認

#### 事前準備

```bash
# テスト用のアクセストークン取得（ログイン後）
# ブラウザの開発者ツール > Application > Local Storage で確認
```

#### テストケース A: 金額不整合の検出

**リクエスト**:
```bash
curl -X POST http://localhost:3000/api/reservations/create \
  -H "Content-Type: application/json" \
  -d '{
    "customerName": "テストユーザー",
    "customerEmail": "test@example.com",
    "customerPhone": "090-1234-5678",
    "serviceName": "4Dまつ毛エクステ",
    "date": "2025-10-20",
    "time": "10:00",
    "price": 10000,
    "maintenancePrice": 2000,
    "totalPrice": 15000,
    "finalPrice": 15000
  }'
```

**期待結果**:
```json
{
  "error": "Total price does not match selected options"
}
```
- ✅ ステータスコード: 400
- ✅ エラーメッセージが返る
- ✅ 予約は作成されない

**正しい値** (検証用):
```json
{
  "totalPrice": 12000
}
```

---

#### テストケース B: ポイント残高不足の検出

**前提条件**:
- テストユーザーのポイント残高: 3000pt

**リクエスト**:
```bash
curl -X POST http://localhost:3000/api/reservations/create \
  -H "Content-Type: application/json" \
  -d '{
    "customerName": "テストユーザー",
    "customerEmail": "test@example.com",
    "customerPhone": "090-1234-5678",
    "serviceName": "4Dまつ毛エクステ",
    "date": "2025-10-20",
    "time": "10:00",
    "price": 12000,
    "maintenancePrice": 0,
    "totalPrice": 12000,
    "pointsUsed": 5000,
    "finalPrice": 7000
  }'
```

**期待結果**:
```json
{
  "error": "ポイント残高が不足しています"
}
```
- ✅ ステータスコード: 400
- ✅ エラーメッセージが返る
- ✅ 予約は作成されない

---

#### テストケース C: 予約枠競合の検出

**前提条件**:
- 2025-10-20 10:00 に既存の予約が存在する

**リクエスト**:
```bash
curl -X POST http://localhost:3000/api/reservations/create \
  -H "Content-Type: application/json" \
  -d '{
    "customerName": "テストユーザー2",
    "customerEmail": "test2@example.com",
    "customerPhone": "090-5678-1234",
    "serviceName": "3Dまつ毛エクステ",
    "date": "2025-10-20",
    "time": "10:00",
    "price": 10000,
    "maintenancePrice": 0,
    "totalPrice": 10000,
    "finalPrice": 10000
  }'
```

**期待結果**:
```json
{
  "error": "選択した日時は既に予約済みです"
}
```
- ✅ ステータスコード: 409 (Conflict)
- ✅ エラーメッセージが返る
- ✅ 予約は作成されない

---

#### テストケース D: 過去日時の検出

**リクエスト**:
```bash
curl -X POST http://localhost:3000/api/reservations/create \
  -H "Content-Type: application/json" \
  -d '{
    "customerName": "テストユーザー",
    "customerEmail": "test@example.com",
    "customerPhone": "090-1234-5678",
    "serviceName": "4Dまつ毛エクステ",
    "date": "2025-01-01",
    "time": "10:00",
    "price": 12000,
    "maintenancePrice": 0,
    "totalPrice": 12000,
    "finalPrice": 12000
  }'
```

**期待結果**:
```json
{
  "error": "過去の日時には予約できません"
}
```
- ✅ ステータスコード: 400
- ✅ エラーメッセージが返る
- ✅ 予約は作成されない

---

#### テストケース E: 正常な予約作成

**リクエスト**:
```bash
curl -X POST http://localhost:3000/api/reservations/create \
  -H "Content-Type: application/json" \
  -d '{
    "customerName": "テストユーザー",
    "customerEmail": "test@example.com",
    "customerPhone": "090-1234-5678",
    "serviceName": "4Dまつ毛エクステ",
    "date": "2025-10-25",
    "time": "14:00",
    "price": 12000,
    "maintenancePrice": 0,
    "totalPrice": 12000,
    "pointsUsed": 0,
    "finalPrice": 12000
  }'
```

**期待結果**:
```json
{
  "success": true,
  "reservationId": "abc123..."
}
```
- ✅ ステータスコード: 200
- ✅ 予約IDが返る
- ✅ Firestoreに予約が保存される
- ✅ 確認メールが送信される

---

## 📊 テスト結果の記録

### テスト1: 会員登録→予約復元フロー

| 確認項目 | 期待結果 | 実際の結果 | ステータス |
|---------|---------|-----------|-----------|
| 氏名の更新 | 田中花子 | | ⬜ |
| メールアドレスの更新 | hanako@test.com | | ⬜ |
| 電話番号の更新 | 090-2222-2222 | | ⬜ |
| サービス情報の維持 | 変更なし | | ⬜ |
| 日付・時刻の維持 | 変更なし | | ⬜ |
| 予約完了 | 成功 | | ⬜ |

### テスト2: DatePickerの動作

| ブラウザ | 日付選択 | クリアボタン | 日付範囲制限 | ステータス |
|---------|---------|------------|------------|-----------|
| Chrome | | | | ⬜ |
| Safari (iOS) | | | | ⬜ |
| Firefox | | | | ⬜ |

### テスト3: APIバリデーション

| テストケース | 期待ステータス | 実際のステータス | ステータス |
|------------|--------------|----------------|-----------|
| A. 金額不整合 | 400 | | ⬜ |
| B. ポイント残高不足 | 400 | | ⬜ |
| C. 予約枠競合 | 409 | | ⬜ |
| D. 過去日時 | 400 | | ⬜ |
| E. 正常な予約 | 200 | | ⬜ |

---

## 🐛 問題が発生した場合

### デバッグ方法

**1. ブラウザの開発者ツールを開く**
```
Chrome: F12 または Cmd+Option+I (Mac)
Safari: Cmd+Option+C (Mac)
Firefox: F12
```

**2. Console タブでエラーを確認**
- JavaScript エラーがないか確認
- Network タブで API リクエストを確認

**3. Network タブでリクエストを確認**
- Status Code を確認
- Response を確認
- Request Payload を確認

**4. サーバーログを確認**
```bash
# ローカル開発サーバーのターミナル出力を確認
# [Middleware Debug] や [Reservation creation error:] などのログ
```

### よくある問題と対処法

**問題1: メンテナンスページが表示される**
```
原因: NEXT_PUBLIC_MAINTENANCE_MODE=true
対処: .env.local で false に設定し、サーバー再起動
```

**問題2: Firebase接続エラー**
```
原因: Firebase設定が正しくない
対処: .env.local のFirebase環境変数を確認
```

**問題3: 予約が作成されない**
```
原因: バリデーションエラー
対処: Network タブでレスポンスを確認
      - 400: リクエストデータに問題
      - 409: 予約枠が競合
      - 500: サーバーエラー
```

**問題4: DatePickerが表示されない**
```
原因: ブラウザが古い
対処: Chrome/Safari/Firefox の最新版を使用
      IE11の場合は text入力にフォールバック
```

---

## ✅ テスト完了の基準

以下すべてが✅になったらテスト完了:

- [ ] テスト1: 会員登録→予約復元フロー（すべての項目が✅）
- [ ] テスト2: DatePickerの動作（3ブラウザすべてが✅）
- [ ] テスト3: APIバリデーション（5ケースすべてが✅）
- [ ] 実機でエンドツーエンドの予約フローが正常に動作

---

## 📝 テスト実施後のアクション

### テスト成功の場合

1. **本番デプロイ準備**
   ```bash
   # メンテナンスモード解除
   # Vercel環境変数を NEXT_PUBLIC_MAINTENANCE_MODE=false に設定
   # 再デプロイ
   ```

2. **ユーザーへの告知**
   - メンテナンス終了のお知らせ
   - 予約再開の案内

### テスト失敗の場合

1. **問題の特定**
   - どのテストケースで失敗したか
   - エラーメッセージは何か
   - 再現手順は何か

2. **修正依頼**
   - 失敗したテストケースの詳細を報告
   - エラーログを共有
   - 期待結果と実際の結果を明記

---

## 🔗 関連ドキュメント

- [FIRESTORE_DETAILED_STATE.md](./FIRESTORE_DETAILED_STATE.md) - データベース構造の詳細
- [MAINTENANCE_MODE.md](./MAINTENANCE_MODE.md) - メンテナンスモードの説明

---

**作成日**: 2025-10-06
**対象バージョン**: Latest (commit c9bc8fe以降)
